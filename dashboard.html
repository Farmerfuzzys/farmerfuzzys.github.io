<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Leitstelle Erfurt - Portal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="sidebar">
        <img src="Farmerfuzzys_logo.jpg" class="nav-logo">
        <button class="nav-btn" onclick="showTab('home')">Startseite</button>
        <button class="nav-btn" id="nav-dispo" style="display:none;" onclick="location.href='leitstelle.html'">Leitstelle</button>
        <button class="nav-btn" id="nav-admin" style="display:none;" onclick="showTab('admin')">Verwaltung</button>
        <button class="nav-btn" onclick="logout()" style="margin-top:auto;">Abmelden</button>
    </nav>

    <main class="main-content">
        <div id="tab-home" class="tab">
            <h1 id="welcome-text">Willkommen zurück</h1>
            <div class="button-grid">
                <div id="card-dispo" class="big-card" style="display:none;" onclick="location.href='leitstelle.html'">
                    <h3>Leitstelle (Disponent)</h3>
                </div>
                <div id="card-ad" class="big-card" style="display:none;" onclick="location.href='alarm_display.html'">
                    <h3>Alarm Display</h3>
                </div>
                <div id="card-fz" class="big-card" style="display:none;" onclick="location.href='fahrzeug.html'">
                    <h3>Fahrzeug-Modus</h3>
                </div>
                <div id="card-admin" class="big-card" style="display:none;" onclick="showTab('admin')">
                    <h3>Verwaltung</h3>
                </div>
            </div>
        </div>

        <div id="tab-admin" class="tab" style="display:none;">
            <h1>Mitglieder & Fahrzeuge verwalten</h1>
            <div class="card">
                <div id="user-list">Lade Daten...</div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { /* DEINE CONFIG HIER */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async user => {
            if(!user) { window.location.href = "index.html"; return; }
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()){
                const d = snap.data();
                const r = d.role || [];
                document.getElementById('welcome-text').innerText = "Willkommen zurück " + d.username;
                
                if(r.includes("Admin")) {
                    document.getElementById('nav-admin').style.display = 'block';
                    document.getElementById('card-admin').style.display = 'flex';
                }
                if(r.includes("Disponent")) {
                    document.getElementById('nav-dispo').style.display = 'block';
                    document.getElementById('card-dispo').style.display = 'flex';
                }
                if(r.includes("AD")) document.getElementById('card-ad').style.display = 'flex';
                if(r.includes("Einsatzfahrzeug")) document.getElementById('card-fz').style.display = 'flex';
            }
        });

        // Logik für Rollen-Update (Toggle-Funktion)
        window.updateRole = async (uid, roleName) => {
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            let roles = snap.data().role || [];
            roles = roles.includes(roleName) ? roles.filter(r => r !== roleName) : [...roles, roleName];
            await updateDoc(userRef, { role: roles });
            loadUserList();
        };

        window.logout = () => signOut(auth);
        window.showTab = (n) => { /* Tab-Wechsel Logik */ };
    </script>
</body>
</html>
