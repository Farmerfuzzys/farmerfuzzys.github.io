<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | FarmerFuzzys</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="sidebar">
        <img src="Farmerfuzzys_logo.jpg" class="nav-logo">
        <button class="nav-btn" onclick="showTab('home')">Startseite</button>
        <button class="nav-btn" onclick="showTab('admin')" id="nav-admin" style="display:none;">Mitglieder</button>
        <button class="nav-btn" onclick="logout()" style="margin-top:auto;">Abmelden</button>
    </nav>

    <main class="main-content">
        <div id="tab-home" class="tab">
            <h1 id="welcome-text">Willkommen zurÃ¼ck</h1>
            <div class="button-grid">
                <div id="card-ad" class="big-card" style="display:none;" onclick="location.href='alarm_display.html'">
                    <span class="icon">ðŸ“º</span>
                    <h3>Alarm Display</h3>
                    <p>Einsatzmonitor Ã¶ffnen</p>
                </div>
                <div id="card-admin" class="big-card" style="display:none;" onclick="showTab('admin')">
                    <span class="icon">ðŸ‘¥</span>
                    <h3>Verwaltung</h3>
                    <p>Mitglieder & Rollen</p>
                </div>
            </div>
        </div>

        <div id="tab-admin" class="tab" style="display:none;">
            <h1>Mitgliederverwaltung</h1>
            <div class="card">
                <div id="user-list">Lade Mitglieder...</div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiYOJWP4XMQRJ6b-RfJp6Aqxis7E-uA30",
            authDomain: "farmerfuzzys-c32eb.firebaseapp.com",
            projectId: "farmerfuzzys-c32eb",
            storageBucket: "farmerfuzzys-c32eb.firebasestorage.app",
            messagingSenderId: "842395157432",
            appId: "1:842395157432:web:fd031d7cc0c2a6e69ec54d"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async user => {
            if(!user) { window.location.href = "index.html"; return; }
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()){
                const d = snap.data();
                const roles = d.role || [];
                document.getElementById('welcome-text').innerText = `Willkommen zurÃ¼ck, ${d.username}`;
                
                // RollenprÃ¼fung fÃ¼r MenÃ¼ & Karten
                if(roles.includes("Admin")) {
                    document.getElementById('nav-admin').style.display = 'block';
                    document.getElementById('card-admin').style.display = 'flex';
                }
                if(roles.includes("AD") || roles.includes("Admin")) {
                    document.getElementById('card-ad').style.display = 'flex';
                }
            }
        });

        window.showTab = (name) => {
            document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
            document.getElementById('tab-' + name).style.display = 'block';
            if(name === 'admin') loadUserList();
        };

        async function loadUserList() {
            const list = document.getElementById('user-list');
            const snap = await getDocs(collection(db, "users"));
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                const r = u.role || [];
                list.innerHTML += `
                    <div class="user-item">
                        <span>${u.username}</span>
                        <div class="role-group">
                            <button onclick="toggleRole('${d.id}', '${JSON.stringify(r)}', 'Admin')" class="glow-btn ${r.includes('Admin')?'gold':''}">Admin</button>
                            <button onclick="toggleRole('${d.id}', '${JSON.stringify(r)}', 'AD')" class="glow-btn ${r.includes('AD')?'green':''}">AD</button>
                            <button onclick="toggleRole('${d.id}', '${JSON.stringify(r)}', 'Gesperrt')" class="glow-btn ${r.includes('Gesperrt')?'red':''}">Sperren</button>
                        </div>
                    </div>`;
            });
        }

        window.toggleRole = async (uid, currentJSON, roleName) => {
            const current = JSON.parse(currentJSON.replace(/'/g, '"'));
            const userRef = doc(db, "users", uid);
            if(current.includes(roleName)) {
                await updateDoc(userRef, { role: arrayRemove(roleName) });
            } else {
                await updateDoc(userRef, { role: arrayUnion(roleName) });
            }
            loadUserList();
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
